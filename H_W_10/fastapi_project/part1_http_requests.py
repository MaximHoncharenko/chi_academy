"""
Ğ”Ğ¾Ğ¼Ğ°ÑˆĞ½Ñ” Ğ·Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ â€” Ğ§Ğ°ÑÑ‚Ğ¸Ğ½Ğ° 1
ĞŸĞ¾Ñ€Ñ–Ğ²Ğ½ÑĞ½Ğ½Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾, Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ‚Ğ° multiprocessing Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ñ–Ğ²
Ğ´Ğ»Ñ Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ 5 HTTP GET Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ² Ğ´Ğ¾ https://httpbin.org/delay/2
"""

import time
import asyncio
import requests
import httpx
import multiprocessing
from concurrent.futures import ProcessPoolExecutor

URL = "https://httpbin.org/delay/2"
NUM_REQUESTS = 5


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Ğ¡Ğ˜ĞĞ¥Ğ ĞĞĞĞ Ñ€ĞµĞ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def sync_request(n: int) -> str:
    """ĞĞ´Ğ¸Ğ½ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğ¹ GET Ğ·Ğ°Ğ¿Ğ¸Ñ‚."""
    response = requests.get(URL, timeout=30)
    print(f"  [sync] Ğ·Ğ°Ğ¿Ğ¸Ñ‚ #{n} Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ â€” ÑÑ‚Ğ°Ñ‚ÑƒÑ {response.status_code}")
    return response.status_code


def run_sync():
    """5 Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ² Ğ²Ğ¸ĞºĞ¾Ğ½ÑƒÑÑ‚ÑŒÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ğ·Ğ° Ğ¾Ğ´Ğ½Ğ¸Ğ¼ â€” ĞºĞ¾Ğ¶ĞµĞ½ Ñ‡ĞµĞºĞ°Ñ” Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½ÑŒĞ¾Ğ³Ğ¾."""
    print("\nğŸ“Œ Ğ¡Ğ˜ĞĞ¥Ğ ĞĞĞĞ Ñ€ĞµĞ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ (requests)")
    print("   Ğ—Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ²Ğ¸ĞºĞ¾Ğ½ÑƒÑÑ‚ÑŒÑÑ Ğ¿Ğ¾ÑĞ»Ñ–Ğ´Ğ¾Ğ²Ğ½Ğ¾ â€” ĞºĞ¾Ğ¶ĞµĞ½ Ğ½Ğ°ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ Ñ‡ĞµĞºĞ°Ñ” Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½ÑŒĞ¾Ğ³Ğ¾.\n")

    start = time.perf_counter()
    for i in range(1, NUM_REQUESTS + 1):
        sync_request(i)
    elapsed = time.perf_counter() - start

    print(f"\n  â±  Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾: {elapsed:.2f} ÑĞµĞº  "
          f"(Ğ¾Ñ‡Ñ–ĞºÑƒÑ”Ñ‚ÑŒÑÑ ~{NUM_REQUESTS * 2} ÑĞµĞº)\n")
    return elapsed


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. ĞĞ¡Ğ˜ĞĞ¥Ğ ĞĞĞĞ Ñ€ĞµĞ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def async_request(client: httpx.AsyncClient, n: int) -> int:
    """ĞĞ´Ğ¸Ğ½ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğ¹ GET Ğ·Ğ°Ğ¿Ğ¸Ñ‚."""
    response = await client.get(URL, timeout=30)
    print(f"  [async] Ğ·Ğ°Ğ¿Ğ¸Ñ‚ #{n} Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ â€” ÑÑ‚Ğ°Ñ‚ÑƒÑ {response.status_code}")
    return response.status_code


async def run_async():
    """
    5 Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ² Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ÑÑ‚ÑŒÑÑ ĞŸĞĞ ĞĞ›Ğ•Ğ›Ğ¬ĞĞ Ñ‡ĞµÑ€ĞµĞ· asyncio.gather().
    Event loop Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºÑƒÑ”Ñ‚ÑŒÑÑ â€” Ğ¿Ğ¾ĞºĞ¸ Ğ¾Ğ´Ğ¸Ğ½ Ğ·Ğ°Ğ¿Ğ¸Ñ‚ Ñ‡ĞµĞºĞ°Ñ” Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ÑŒ,
    Ñ–Ğ½ÑˆÑ– Ñ‚ĞµĞ¶ Ğ²Ğ¸ĞºĞ¾Ğ½ÑƒÑÑ‚ÑŒÑÑ.
    """
    print("\nâš¡ ĞĞ¡Ğ˜ĞĞ¥Ğ ĞĞĞĞ Ñ€ĞµĞ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ (httpx + asyncio)")
    print("   Ğ£ÑÑ– 5 Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ² ÑÑ‚Ğ°Ñ€Ñ‚ÑƒÑÑ‚ÑŒ Ğ¾Ğ´Ğ½Ğ¾Ñ‡Ğ°ÑĞ½Ğ¾ â€” event loop Ğ¿ĞµÑ€ĞµĞ¼Ğ¸ĞºĞ°Ñ”Ñ‚ÑŒÑÑ Ğ¼Ñ–Ğ¶ Ğ½Ğ¸Ğ¼Ğ¸.\n")

    start = time.perf_counter()
    async with httpx.AsyncClient() as client:
        tasks = [async_request(client, i) for i in range(1, NUM_REQUESTS + 1)]
        await asyncio.gather(*tasks)
    elapsed = time.perf_counter() - start

    print(f"\n  â±  ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾: {elapsed:.2f} ÑĞµĞº  "
          f"(Ğ¾Ñ‡Ñ–ĞºÑƒÑ”Ñ‚ÑŒÑÑ ~2 ÑĞµĞº â€” Ğ²ÑÑ– Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ğ¾)\n")
    return elapsed


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. MULTIPROCESSING Ñ€ĞµĞ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def mp_request(n: int) -> int:
    """
    Ğ’Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ğ¾ĞºÑ€ĞµĞ¼Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–.
    ĞšĞ¾Ğ¶ĞµĞ½ Ğ¿Ñ€Ğ¾Ñ†ĞµÑ â€” Ğ½ĞµĞ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¸Ğ¹ Python Ñ–Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ‚Ğ¾Ñ€,
    Ñ‚Ğ¾Ğ¼Ñƒ GIL Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ¶Ğ°Ñ” ÑĞ¿Ñ€Ğ°Ğ²Ğ¶Ğ½ÑŒĞ¾Ğ¼Ñƒ Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»Ñ–Ğ·Ğ¼Ñƒ.
    """
    response = requests.get(URL, timeout=30)
    print(f"  [multiprocessing] Ğ·Ğ°Ğ¿Ğ¸Ñ‚ #{n} Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ â€” ÑÑ‚Ğ°Ñ‚ÑƒÑ {response.status_code} "
          f"(PID: {multiprocessing.current_process().pid})")
    return response.status_code


def run_multiprocessing():
    """
    5 Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ² Ñƒ 5 Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑĞ°Ñ… â€” ÑĞ¿Ñ€Ğ°Ğ²Ğ¶Ğ½Ñ–Ğ¹ Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»Ñ–Ğ·Ğ¼ Ğ½Ğ° Ñ€Ñ–Ğ²Ğ½Ñ– ĞĞ¡.
    Ğ”Ğ»Ñ I/O-bound Ğ·Ğ°Ğ´Ğ°Ñ‡ (HTTP Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸) â€” Ğ¼ĞµĞ½Ñˆ ĞµÑ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¸Ğ¹ Ğ·Ğ° asyncio,
    Ğ±Ğ¾ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ² ĞºĞ¾ÑˆÑ‚ÑƒÑ” Ğ´Ğ¾Ñ€Ğ¾Ğ¶Ñ‡Ğµ, Ğ½Ñ–Ğ¶ ĞºĞ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ¸.
    """
    print("\nğŸ”€ MULTIPROCESSING Ñ€ĞµĞ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ")
    print("   ĞšĞ¾Ğ¶ĞµĞ½ Ğ·Ğ°Ğ¿Ğ¸Ñ‚ Ğ²Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ğ¾ĞºÑ€ĞµĞ¼Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ– ĞĞ¡.\n")

    start = time.perf_counter()
    with ProcessPoolExecutor(max_workers=NUM_REQUESTS) as executor:
        futures = [executor.submit(mp_request, i) for i in range(1, NUM_REQUESTS + 1)]
        results = [f.result() for f in futures]
    elapsed = time.perf_counter() - start

    print(f"\n  â±  Multiprocessing: {elapsed:.2f} ÑĞµĞº  "
          f"(Ğ¾Ñ‡Ñ–ĞºÑƒÑ”Ñ‚ÑŒÑÑ ~2-4 ÑĞµĞº â€” Ğ½Ğ°ĞºĞ»Ğ°Ğ´Ğ½Ñ– Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ¸ Ğ½Ğ° ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²)\n")
    return elapsed


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞŸĞ†Ğ”Ğ¡Ğ£ĞœĞšĞĞ’Ğ• ĞŸĞĞ Ğ†Ğ’ĞĞ¯ĞĞĞ¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def print_summary(sync_t: float, async_t: float, mp_t: float):
    print("=" * 60)
    print("ğŸ“Š ĞŸĞ†Ğ”Ğ¡Ğ£ĞœĞĞš ĞŸĞĞ Ğ†Ğ’ĞĞ¯ĞĞĞ¯")
    print("=" * 60)
    print(f"  Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾:       {sync_t:>7.2f} ÑĞµĞº  {'ğŸ¢' * 5}")
    print(f"  Asyncio:         {async_t:>7.2f} ÑĞµĞº  {'âš¡' * 5}")
    print(f"  Multiprocessing: {mp_t:>7.2f} ÑĞµĞº  {'ğŸ”€' * 5}")
    print()
    print(f"  Asyncio Ğ¿Ñ€Ğ¸ÑˆĞ²Ğ¸Ğ´ÑˆĞµĞ½Ğ½Ñ:        x{sync_t / async_t:.1f} Ğ¿Ğ¾Ñ€Ñ–Ğ²Ğ½ÑĞ½Ğ¾ Ğ· sync")
    print(f"  Multiprocessing Ğ¿Ñ€Ğ¸ÑˆĞ²Ğ¸Ğ´Ñˆ.:   x{sync_t / mp_t:.1f} Ğ¿Ğ¾Ñ€Ñ–Ğ²Ğ½ÑĞ½Ğ¾ Ğ· sync")
    print()
    print("ğŸ’¡ Ğ’Ğ˜Ğ¡ĞĞĞ’ĞšĞ˜:")
    print("  â€¢ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ â€” Ğ½Ğ°Ğ¹Ğ¿Ğ¾Ğ²Ñ–Ğ»ÑŒĞ½Ñ–ÑˆĞµ: Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ¿Ğ¾ Ñ‡ĞµÑ€Ğ·Ñ–.")
    print("  â€¢ Asyncio   â€” Ğ½Ğ°Ğ¹ÑˆĞ²Ğ¸Ğ´ÑˆĞµ Ğ´Ğ»Ñ I/O: Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ğ¾Ñ‚Ñ–Ğº, Ğ¾Ğ´Ğ¸Ğ½ Ğ¿Ñ€Ğ¾Ñ†ĞµÑ,")
    print("    event loop Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ğ¾ 'Ğ¶Ğ¾Ğ½Ğ³Ğ»ÑÑ”' Ğ²ÑÑ–Ğ¼Ğ° Ğ¾Ñ‡Ñ–ĞºÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼Ğ¸.")
    print("  â€¢ Multiprocessing â€” Ñ‚ĞµĞ¶ Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ğ¾, Ğ°Ğ»Ğµ Ğ´Ğ¾Ñ€Ğ¾Ğ¶Ñ‡Ğµ Ñ‡ĞµÑ€ĞµĞ·")
    print("    Ğ½Ğ°ĞºĞ»Ğ°Ğ´Ğ½Ñ– Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ¸ Ğ½Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ² (Ñ„Ğ¾Ñ€Ğº ĞĞ¡).")
    print("  â€¢ Ğ”Ğ»Ñ HTTP-Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ² Ğ—ĞĞ’Ğ–Ğ”Ğ˜ Ğ¾Ğ±Ğ¸Ñ€Ğ°Ğ¹ asyncio + httpx/aiohttp!")
    print("=" * 60)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ¢ĞĞ§ĞšĞ Ğ’Ğ¥ĞĞ”Ğ£
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    print("=" * 60)
    print(" ğŸŒ ĞŸĞĞ Ğ†Ğ’ĞĞ¯ĞĞĞ¯: sync vs async vs multiprocessing")
    print(f"    {NUM_REQUESTS} GET Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ² Ğ´Ğ¾ {URL}")
    print("=" * 60)

    # 1. Sync
    t_sync = run_sync()

    # 2. Async
    t_async = asyncio.run(run_async())

    # 3. Multiprocessing
    t_mp = run_multiprocessing()

    # 4. Summary
    print_summary(t_sync, t_async, t_mp)
